{% extends "layouts/base_model.html" %}
{% block subtitle %}Deployment Detail{% endblock %}
{% block modelbody %}
<div class="section-tab-mobile">
    <ul>
        <a href="/{{ model.id }}">
            <li>Summary</li>
        </a>
        <a href="/{{ model.id }}/experiments">
            <li>Experiments</li>
        </a>
        <a href="/{{ model.id }}/snapshots">
            <li>Snapshots</li>
        </a>
        <a href="/{{ model.id }}/deployments">
            <li>Deployments</li>
        </a>
    </ul>
</div>
<div class="section-tab">
    <div class="row">
        <div class="col-xs-12">
            <ul>
                <a href="/{{ model.id }}" class="">
                    <li>Summary</li>
                </a>
                <a href="/{{ model.id }}/experiments" class="">
                    <li>Experiments</li>
                </a>
                <a href="/{{ model.id }}/snapshots" class="">
                    <li>Snapshots</li>
                </a>
                <a href="/{{ model.id }}/deployments" class="active">
                    <li>Deployments</li>
                </a>
            </ul>
        </div>
    </div>
</div>
<div class="model-section-content-wrapper">

    <div class="content-box multi-item">
        <div class="multi-item-content-wrap">

            <div class="multi-item-content-row snapshot-filters">
                <span> <a href="/{{ model.id }}/deployments">deployments</a></span>
                <span> > <a href="#">{{ deployment_version_id }}</a></span>
                <span> > <a href="#">{{ model_version_id }}</a></span>
            </div>

            <div class="container inner">
                <div class="container inner">
                    <h2>Select Graphs to Add</h2>
                    <div class="row">
                        <div class="col-md-10">
                            <h3>Inputs</h3>
                            {% for input_key in input_keys %}
                                <span>{{ input_key }}:
                                ts<input type="checkbox" name="input-{{ input_key }}-timeseries" onchange="clickCheckbox('input', '{{ input_key | safe}}', 'timeseries');">,
                                hist<input type="checkbox" name="input-{{ input_key }}-histogram" onchange="clickCheckbox('input', '{{ input_key | safe}}', 'histogram');">
                            {% endfor %}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-10">
                            <h3>Predictions</h3>
                            {% for prediction_key in prediction_keys %}
                                <span>{{ prediction_key }}:
                                ts<input type="checkbox" name="prediction-{{ prediction_key }}-timeseries" onchange="clickCheckbox('prediction', '{{ prediction_key | safe}}', 'timeseries');">,
                                hist<input type="checkbox" name="prediction-{{ prediction_key }}-histogram" onchange="clickCheckbox('prediction', '{{ prediction_key | safe}}', 'histogram');">
                            {% endfor %}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-10">
                            <h3>Feedback</h3>
                            {% for feedback_key in feedback_keys %}
                                <span>{{ feedback_key }}:
                                ts<input type="checkbox" name="feedback-{{ feedback_key }}-timeseries" onchange="clickCheckbox('feedback', '{{ feedback_key | safe}}', 'timeseries');">,
                                hist<input type="checkbox" name="feedback-{{ feedback_key }}-histogram" onchange="clickCheckbox('feedback', '{{ feedback_key | safe}}', 'histogram');">
                            {% endfor %}
                        </div>
                    </div>
                </div>
                <div class="container inner">
                    <div class="row">
                        <div class="col-md-10">
                            <h2>Use the template code to create visualizations for your running model</h2>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-10">
                             <pre><code class="python">
    import cool
    def new_func(var):
        return "hello"
                    </code></pre>
                        </div>
                    </div>
                </div>
                <div class="container inner">
                    <h2>Add or remove graphs with the controls above and drag graphs around to rearrange</h2>
                    <div class="container graph-display">

                    </div>
                </div>
            </div>

            <!-- D3.js -->
            <script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js"></script>
            <!-- jQuery -->
            <script src="//code.jquery.com/jquery-2.1.4.min.js"></script>
            <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

            <!-- highlight.js -->
            <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/default.min.css">
            <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/highlight.min.js"></script>
            <script>hljs.initHighlightingOnLoad();</script>

            <!-- Plotly.js -->
            <script src="//d14fo0winaifog.cloudfront.net/plotly-basic.js"></script>

            <script type="text/javascript">
                function clickCheckbox(dataType, name, graphType) {
                    var graphId = dataType + "-" + name + "-" + graphType;
                    var checkBox = $("input[name=" + graphId);

                    // print to check
                    console.log(checkBox.prop("checked"));

                    // actually do something after the checkbox is marked
                    if(checkBox.prop("checked") === true) {
                        addGraph(dataType, name, graphType);
                    } else {
                        removeGraph(dataType, name, graphType);
                    }

                }

                function removeGraph(dataType, name, graphType) {
                    var graphId = dataType + "-" + name + "-" + graphType;

                    // remove the graph from the "graph-display" div
                    $(".container-" + graphId).remove();
                    console.log("removed " + graphType + " graph for " + dataType + "with name" + name)
                }

                function addGraph(dataType, name, graphType) {
                    var graphId = dataType + "-" + name + "-" + graphType;

                    // add in the graph to the "graph-display" div
                    $(".graph-display").append("<div class=\"card col-md-4 container-" + graphId + "\" id=\"draggable-" + graphId + "\">\n" +
                        "                            <div id=\"" + graphId + "\"></div>\n" +
                        "                        </div>");

                    // add a bare graph in the div based on graph_type
                    if(graphType === "timeseries") {
                        var newGraphData = {
                            data: [{
                                x: [],
                                y: [],
                                type: "scatter",
                                mode: "lines+markers",
                                marker: {
                                    size: 10,
                                    color: "rgb(40,165,187)",
                                    line: {
                                        width: 2,
                                        color: "rgb(80,80,80)"
                                    }
                                }
                            }],
                            layout: {
                                title: "time series for " + dataType + " with name " + name,
                                xaxis: {
                                    title: "created at"
                                },
                                yaxis: {
                                    title: name
                                }
                            }
                        }
                        Plotly.plot(graphId, newGraphData.data, newGraphData.layout);
                    } else if(graphType === "histogram") {
                        var newGraphData = {
                            data: [{
                                x: [],
                                y: [],
                                type: "bar",
                                marker: {
                                    size: 10,
                                    color: "rgb(40,165,187)",
                                    line: {
                                        width: 1.5,
                                        color: "rgb(80,80,80)"
                                    }
                                }
                            }],
                            layout: {
                                title: "histogram for " + dataType + " with name " + name,
                                xaxis: {
                                    title: "buckets"
                                },
                                yaxis: {
                                    title: "counts"
                                }
                            }
                        }
                        Plotly.plot(graphId, newGraphData.data, newGraphData.layout);
                    }

                    // start a timer to pull data for this graph and update the graph
                    var startCounter = 0; // start a counter to pull latest data
                    setInterval(function() {
                        $.ajax({
                            url: "/data/{{ model.id }}/{{ deployment_version_id }}/{{ model_version_id }}",
                            type: "GET",
                            data: {
                                start: startCounter,
                                data_type: dataType,
                                name: name,
                                graph_type: graphType,
                            },
                            async: true,
                            success: function(data) {
                                // Parse the data to be passed to plotly from the endpoint data
                                var graphData = JSON.parse(data.graph_data_output_json_str);
                                console.log(graphData);
                                var numNewResults = data.num_new_results;
                                console.log(numNewResults);

                                // Extend the graph as per the type of graph
                                if(graphType === "timeseries") {
                                    Plotly.extendTraces(graphId, graphData.new_data, [0]);
                                } else if(graphType === "histogram") {
                                    Plotly.restyle(graphId, graphData.cumulative_data, [0]);
                                }

                                // Update the startCounter to get the new data
                                startCounter = startCounter + numNewResults;

                            },
                            dataType: "json"
                        });
                    }, 2000);
                    // make the container for the graph draggable
                    $("#draggable-" + graphId).draggable();
                    console.log("added " + graphType + " graph for " + dataType + "with name " + name)
                }
            </script>

        </div>
    </div>
</div>
{% endblock %}