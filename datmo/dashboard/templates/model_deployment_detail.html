{% extends "layouts/base_model.html" %}
{% block subtitle %}Deployment Detail{% endblock %}
{% block modelbody %}
<div class="section-tab-mobile">
    <ul>
        <a href="/{{ model.id }}">
            <li>Summary</li>
        </a>
        <a href="/{{ model.id }}/experiments">
            <li>Experiments</li>
        </a>
        <a href="/{{ model.id }}/snapshots">
            <li>Snapshots</li>
        </a>
        <a href="/{{ model.id }}/deployments">
            <li>Deployments</li>
        </a>
    </ul>
</div>
<div class="section-tab">
    <div class="row">
        <div class="col-xs-12">
            <ul>
                <a href="/{{ model.id }}" class="">
                    <li>Summary</li>
                </a>
                <a href="/{{ model.id }}/experiments" class="">
                    <li>Experiments</li>
                </a>
                <a href="/{{ model.id }}/snapshots" class="">
                    <li>Snapshots</li>
                </a>
                <a href="/{{ model.id }}/deployments" class="active">
                    <li>Deployments</li>
                </a>
            </ul>
        </div>
    </div>
</div>
<div class="model-section-content-wrapper">

    <div class="content-box multi-item">
        <div class="multi-item-content-wrap">

            <div class="multi-item-content-row snapshot-filters">
                <span> <a href="/{{ model.id }}/deployments">deployments</a></span>
                <span> > <a href="#">{{ deployment_version_id }}</a></span>
                <span> > <a href="#">{{ model_version_id }}</a></span>
            </div>

            <div class="container inner">
                <div class="container inner">
                    <h2>Select Graphs to Add</h2>
                    <div class="row">
                        <div class="col-md-10">
                            <h3>Inputs</h3>
                            {% for input_key in input_keys %}
                                <span>{{ input_key }}:
                                ts<input type="checkbox" name="input-{{ input_key }}-timeseries" onchange="clickCheckbox('input', '{{ input_key | safe}}', 'timeseries');">,
                                hist<input type="checkbox" name="input-{{ input_key }}-histogram" onchange="clickCheckbox('input', '{{ input_key | safe}}', 'histogram');">
                            {% endfor %}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-10">
                            <h3>Predictions</h3>
                            {% for prediction_key in prediction_keys %}
                                <span>{{ prediction_key }}:
                                ts<input type="checkbox" name="prediction-{{ prediction_key }}-timeseries" onchange="clickCheckbox('prediction', '{{ prediction_key | safe}}', 'timeseries');">,
                                hist<input type="checkbox" name="prediction-{{ prediction_key }}-histogram" onchange="clickCheckbox('prediction', '{{ prediction_key | safe}}', 'histogram');">
                            {% endfor %}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-10">
                            <h3>Feedback</h3>
                            {% for feedback_key in feedback_keys %}
                                <span>{{ feedback_key }}:
                                ts<input type="checkbox" name="feedback-{{ feedback_key }}-timeseries" onchange="clickCheckbox('feedback', '{{ feedback_key | safe}}', 'timeseries');">,
                                hist<input type="checkbox" name="feedback-{{ feedback_key }}-histogram" onchange="clickCheckbox('feedback', '{{ feedback_key | safe}}', 'histogram');">
                            {% endfor %}
                        </div>
                    </div>
                </div>
                <div class="container inner">
                    <div class="row">
                        <div class="col-md-10">
                            <h2>Use the template code to create visualizations for your running model</h2>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-10">
                             <div id="editor" style="height: 500px;">import os
import time
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
import matplotlib.patches as mpatches
from sklearn.decomposition import PCA
from datmo.monitoring import Monitoring

# Set save location
save_directory = os.path.dirname(os.path.realpath(__file__))

# Set datmo client
datmo_client = Monitoring(api_key="6a3a3cd900eaf7b406a41d68f8ca7969")

filter_schema = {"model_id": "{{ model.id }}",
                 "deployment_version_id": "{{ deployment_version_id }}",
                 "model_version_id": "{{ model_version_id }}"}

# Get data during inference from datmo
rows = datmo_client.search_metadata(filter_schema)

# Form pandas dataframe for the prediction data
inputs = []
predictions = []
for row in rows:
    prediction = {'Class': row['prediction']['prediction']}
    input_dict = row['input']
    inputs.append(input_dict)
    predictions.append(prediction)
# Transform and predict using model
X = pd.DataFrame(inputs)
y = pd.DataFrame(predictions)
X.sort_index(axis=1,inplace=True)

# Perform PCA over the input features during the prediction
t0 = time.time()
X_reduced_pca = PCA(n_components=2, random_state=42).fit_transform(X.values)
t1 = time.time()

# Plot the graph and save them
plt.suptitle('Clusters using Dimensionality Reduction', fontsize=14)
blue_patch = mpatches.Patch(color='#0A0AFF', label='No Fraud')
red_patch = mpatches.Patch(color='#AF0000', label='Fraud')

new_y = y.values.ravel()
plt.scatter(X_reduced_pca[:,0], X_reduced_pca[:,1], c=(new_y == 0), cmap='coolwarm', label='No Fraud', linewidths=2)
plt.scatter(X_reduced_pca[:,0], X_reduced_pca[:,1], c=(new_y == 1), cmap='coolwarm', label='Fraud', linewidths=2)
plt.legend(handles=[blue_patch, red_patch])
plt.grid(True)
plt.savefig(os.path.join(save_directory, 'image.jpg'))
                             </div>
                        </div>
                    </div>
                    <button class="cta" onclick="addCustomGraph()">add</button>
                </div>
                <div class="container inner">
                    <h2>Add or remove graphs with the controls above and drag graphs around to rearrange</h2>
                    <div class="container graph-display">

                    </div>
                </div>
            </div>

            <!-- D3.js -->
            <script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js"></script>
            <!-- jQuery -->
            <script src="//code.jquery.com/jquery-2.1.4.min.js"></script>
            <script src="//code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

            <!-- ace.js -->
            <script src="//cdnjs.cloudflare.com/ajax/libs/ace/1.4.1/ace.js" type="text/javascript" charset="utf-8"></script>
            <!-- filesaver.js -->
            <script>
                var editor = ace.edit("editor", {
                    mode: "ace/mode/python",
                    theme: "ace/theme/monokai"
                });

                function addCustomGraph() {
                    saveCustomCode("custom.py");
                    setInterval(runPythonScript, 2000, "custom.py");
                }

                function saveCustomCode(filepath){
                    $.ajax({
                        url: "/{{ model.id }}/deployments/{{ deployment_version_id }}/{{ model_version_id }}/script/create",
                        type: "GET",
                        data: {
                            content: editor.getValue(),
                            filepath: filepath
                        },
                        async: true,
                        success: function(data) {
                            console.log("file has been saved at " + filepath);
                        },
                        dataType: "json"
                    });
                }

                function runPythonScript(filepath) {
                    $.ajax({
                        url: "/{{ model.id }}/deployments/{{ deployment_version_id }}/{{ model_version_id }}/script/run",
                        type: "GET",
                        data: {
                            filepath: filepath
                        },
                        async: true,
                        success: function(data) {
                            console.log("file with path " + filepath + "has been run");
                        },
                        dataType: "json"
                    });
                }
            </script>

            <!-- Plotly.js -->
            <script src="//d14fo0winaifog.cloudfront.net/plotly-basic.js"></script>

            <script type="text/javascript">
                function clickCheckbox(dataType, name, graphType) {
                    var graphId = dataType + "-" + name + "-" + graphType;
                    var checkBox = $("input[name=" + graphId);

                    // print to check
                    console.log(checkBox.prop("checked"));

                    // actually do something after the checkbox is marked
                    if(checkBox.prop("checked") === true) {
                        addGraph(dataType, name, graphType);
                    } else {
                        removeGraph(dataType, name, graphType);
                    }

                }

                function removeGraph(dataType, name, graphType) {
                    var graphId = dataType + "-" + name + "-" + graphType;

                    // remove the graph from the "graph-display" div
                    $(".container-" + graphId).remove();
                    console.log("removed " + graphType + " graph for " + dataType + "with name" + name)
                }

                function addGraph(dataType, name, graphType) {
                    var graphId = dataType + "-" + name + "-" + graphType;

                    // add in the graph to the "graph-display" div
                    $(".graph-display").append("<div class=\"card col-md-4 container-" + graphId + "\" id=\"draggable-" + graphId + "\">\n" +
                        "                            <div id=\"" + graphId + "\"></div>\n" +
                        "                        </div>");

                    // add a bare graph in the div based on graph_type
                    if(graphType === "timeseries") {
                        var newGraphData = {
                            data: [{
                                x: [],
                                y: [],
                                type: "scatter",
                                mode: "lines+markers",
                                marker: {
                                    size: 10,
                                    color: "rgb(40,165,187)",
                                    line: {
                                        width: 2,
                                        color: "rgb(80,80,80)"
                                    }
                                }
                            }],
                            layout: {
                                title: graphType + ", " + dataType + ": " + name,
                                xaxis: {
                                    title: "created at"
                                },
                                yaxis: {
                                    title: name
                                }
                            }
                        }
                        Plotly.plot(graphId, newGraphData.data, newGraphData.layout);
                    } else if(graphType === "histogram") {
                        var newGraphData = {
                            data: [{
                                x: [],
                                y: [],
                                type: "bar",
                                marker: {
                                    size: 10,
                                    color: "rgb(40,165,187)",
                                    line: {
                                        width: 1.5,
                                        color: "rgb(80,80,80)"
                                    }
                                }
                            }],
                            layout: {
                                title: graphType + ", " + dataType + ": " + name,
                                xaxis: {
                                    title: "buckets"
                                },
                                yaxis: {
                                    title: "counts"
                                }
                            }
                        }
                        Plotly.plot(graphId, newGraphData.data, newGraphData.layout);
                    }

                    // start a timer to pull data for this graph and update the graph
                    var startCounter = 0; // start a counter to pull latest data
                    setInterval(function() {
                        $.ajax({
                            url: "/data/{{ model.id }}/deployments/{{ deployment_version_id }}/{{ model_version_id }}",
                            type: "GET",
                            data: {
                                start: startCounter,
                                data_type: dataType,
                                name: name,
                                graph_type: graphType,
                            },
                            async: true,
                            success: function(data) {
                                // Parse the data to be passed to plotly from the endpoint data
                                var graphData = JSON.parse(data.graph_data_output_json_str);
                                console.log(graphData);
                                var numNewResults = data.num_new_results;
                                console.log(numNewResults);

                                // Extend the graph as per the type of graph
                                if(graphType === "timeseries") {
                                    Plotly.extendTraces(graphId, graphData.new_data, [0]);
                                } else if(graphType === "histogram") {
                                    Plotly.restyle(graphId, graphData.cumulative_data, [0]);
                                }

                                // Update the startCounter to get the new data
                                startCounter = startCounter + numNewResults;

                            },
                            dataType: "json"
                        });
                    }, 2000);
                    // make the container for the graph draggable
                    $("#draggable-" + graphId).draggable();
                    console.log("added " + graphType + " graph for " + dataType + "with name " + name)
                }
            </script>

        </div>
    </div>
</div>
{% endblock %}